<!DOCTYPE html><html lang="en"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1.0"><meta name="generator" content="rustdoc"><meta name="description" content="API documentation for the Rust `coop` mod in crate `tokio`."><meta name="keywords" content="rust, rustlang, rust-lang, coop"><title>tokio::coop - Rust</title><link rel="stylesheet" type="text/css" href="../../normalize.css"><link rel="stylesheet" type="text/css" href="../../rustdoc.css" id="mainThemeStyle"><link rel="stylesheet" type="text/css" href="../../light.css"  id="themeStyle"><link rel="stylesheet" type="text/css" href="../../dark.css" disabled ><link rel="stylesheet" type="text/css" href="../../ayu.css" disabled ><script src="../../storage.js"></script><noscript><link rel="stylesheet" href="../../noscript.css"></noscript><link rel="shortcut icon" href="../../favicon.ico"><style type="text/css">#crate-search{background-image:url("../../down-arrow.svg");}</style></head><body class="rustdoc mod"><!--[if lte IE 8]><div class="warning">This old browser is unsupported and will most likely display funky things.</div><![endif]--><nav class="sidebar"><div class="sidebar-menu">&#9776;</div><a href='../../tokio/index.html'><div class='logo-container'><img src='../../rust-logo.png' alt='logo'></div></a><p class='location'>Module coop</p><div class="sidebar-elems"><div class="block items"><ul><li><a href="#structs">Structs</a></li><li><a href="#constants">Constants</a></li><li><a href="#functions">Functions</a></li></ul></div><p class='location'><a href='../index.html'>tokio</a></p><script>window.sidebarCurrent = {name: 'coop', ty: 'mod', relpath: '../'};</script><script defer src="../sidebar-items.js"></script></div></nav><div class="theme-picker"><button id="theme-picker" aria-label="Pick another theme!"><img src="../../brush.svg" width="18" alt="Pick another theme!"></button><div id="theme-choices"></div></div><script src="../../theme.js"></script><nav class="sub"><form class="search-form"><div class="search-container"><div><select id="crate-search"><option value="All crates">All crates</option></select><input class="search-input" name="search" disabled autocomplete="off" spellcheck="false" placeholder="Click or press ‘S’ to search, ‘?’ for more options…" type="search"></div><a id="settings-menu" href="../../settings.html"><img src="../../wheel.svg" width="18" alt="Change settings"></a></div></form></nav><section id="main" class="content"><h1 class='fqn'><span class='out-of-band'><span id='render-detail'><a id="toggle-all-docs" href="javascript:void(0)" title="collapse all docs">[<span class='inner'>&#x2212;</span>]</a></span><a class='srclink' href='../../src/tokio/coop.rs.html#1-241' title='goto source code'>[src]</a></span><span class='in-band'>Module <a href='../index.html'>tokio</a>::<wbr><a class="mod" href=''>coop</a></span></h1><div class='docblock'><p>Opt-in yield points for improved cooperative scheduling.</p>
<p>A single call to <a href="https://doc.rust-lang.org/std/future/trait.Future.html#tymethod.poll"><code>poll</code></a> on a top-level task may potentially do a lot of
work before it returns <code>Poll::Pending</code>. If a task runs for a long period of
time without yielding back to the executor, it can starve other tasks
waiting on that executor to execute them, or drive underlying resources.
Since Rust does not have a runtime, it is difficult to forcibly preempt a
long-running task. Instead, this module provides an opt-in mechanism for
futures to collaborate with the executor to avoid starvation.</p>
<p>Consider a future like this one:</p>

<div class="example-wrap"><pre class="rust rust-example-rendered">
<span class="kw">async</span> <span class="kw">fn</span> <span class="ident">drop_all</span><span class="op">&lt;</span><span class="ident">I</span>: <span class="ident">Stream</span> <span class="op">+</span> <span class="ident">Unpin</span><span class="op">&gt;</span>(<span class="kw-2">mut</span> <span class="ident">input</span>: <span class="ident">I</span>) {
    <span class="kw">while</span> <span class="kw">let</span> <span class="prelude-val">Some</span>(<span class="kw">_</span>) <span class="op">=</span> <span class="ident">input</span>.<span class="ident">next</span>().<span class="kw">await</span> {}
}</pre></div>
<p>It may look harmless, but consider what happens under heavy load if the
input stream is <em>always</em> ready. If we spawn <code>drop_all</code>, the task will never
yield, and will starve other tasks and resources on the same executor. With
opt-in yield points, this problem is alleviated:</p>

<div class='information'><div class='tooltip ignore'>ⓘ<span class='tooltiptext'>This example is not tested</span></div></div><div class="example-wrap"><pre class="rust rust-example-rendered ignore">
<span class="kw">async</span> <span class="kw">fn</span> <span class="ident">drop_all</span><span class="op">&lt;</span><span class="ident">I</span>: <span class="ident">Stream</span> <span class="op">+</span> <span class="ident">Unpin</span><span class="op">&gt;</span>(<span class="kw-2">mut</span> <span class="ident">input</span>: <span class="ident">I</span>) {
    <span class="kw">while</span> <span class="kw">let</span> <span class="prelude-val">Some</span>(<span class="kw">_</span>) <span class="op">=</span> <span class="ident">input</span>.<span class="ident">next</span>().<span class="kw">await</span> {
        <span class="ident">tokio</span>::<span class="ident">coop</span>::<span class="ident">proceed</span>().<span class="kw">await</span>;
    }
}</pre></div>
<p>The <code>proceed</code> future will coordinate with the executor to make sure that
every so often control is yielded back to the executor so it can run other
tasks.</p>
<h1 id="placing-yield-points" class="section-header"><a href="#placing-yield-points">Placing yield points</a></h1>
<p>Voluntary yield points should be placed <em>after</em> at least some work has been
done. If they are not, a future sufficiently deep in the task hierarchy may
end up <em>never</em> getting to run because of the number of yield points that
inevitably appear before it is reached. In general, you will want yield
points to only appear in &quot;leaf&quot; futures -- those that do not themselves poll
other futures. By doing this, you avoid double-counting each iteration of
the outer future against the cooperating budget.</p>
</div><h2 id='structs' class='section-header'><a href="#structs">Structs</a></h2>
<table><tr class='module-item'><td><a class="struct" href="struct.Budget.html" title='tokio::coop::Budget struct'>Budget</a></td><td class='docblock-short'><p>Opaque type tracking the amount of &quot;work&quot; a task may still do before
yielding back to the scheduler.</p>
</td></tr></table><h2 id='constants' class='section-header'><a href="#constants">Constants</a></h2>
<table><tr class='module-item'><td><a class="constant" href="constant.CURRENT.html" title='tokio::coop::CURRENT constant'>CURRENT</a></td><td class='docblock-short'></td></tr></table><h2 id='functions' class='section-header'><a href="#functions">Functions</a></h2>
<table><tr class='module-item'><td><a class="fn" href="fn.budget.html" title='tokio::coop::budget fn'>budget</a></td><td class='docblock-short'><p>Run the given closure with a cooperative task budget. When the function
returns, the budget is reset to the value prior to calling the function.</p>
</td></tr><tr class='module-item'><td><a class="fn" href="fn.has_budget_remaining.html" title='tokio::coop::has_budget_remaining fn'>has_budget_remaining</a></td><td class='docblock-short'></td></tr><tr class='module-item'><td><a class="fn" href="fn.poll_proceed.html" title='tokio::coop::poll_proceed fn'>poll_proceed</a></td><td class='docblock-short'><p>Returns <code>Poll::Pending</code> if the current task has exceeded its budget and should yield.</p>
</td></tr><tr class='module-item'><td><a class="fn" href="fn.stop.html" title='tokio::coop::stop fn'>stop</a></td><td class='docblock-short'><p>Forcibly remove the budgeting constraints early.</p>
</td></tr><tr class='module-item'><td><a class="fn" href="fn.with_budget.html" title='tokio::coop::with_budget fn'>with_budget</a></td><td class='docblock-short'></td></tr></table></section><section id="search" class="content hidden"></section><section class="footer"></section><script>window.rootPath = "../../";window.currentCrate = "tokio";</script><script src="../../main.js"></script><script defer src="../../search-index.js"></script></body></html>